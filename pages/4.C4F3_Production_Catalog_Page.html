<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Catalog – Coffee Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to top right, #6F4E37, #D2B48C);
      font-family: 'Sans-serif';
    }

    .glass {
      background: rgba(255, 248, 231, 0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 248, 231, 0.25);
      border-radius: 1rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .glass:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(210, 105, 30, 0.6), 0 0 30px rgba(160, 82, 45, 0.4);
    }

    .gradient-button {
      background: linear-gradient(60deg, #A0522D, #D2691E, #8B4513, #A0522D);
      background-size: 400% 400%;
      animation: gradientMove 4s linear infinite;
      color: white;
      font-weight: 600;
      border-radius: 1rem;
      padding: 0.75rem 1.5rem;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .gradient-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(210, 105, 30, 0.6), 0 0 25px rgba(160, 82, 45, 0.4);
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .star {
      color: gold;
      font-size: 1rem;
      margin-right: 2px;
      transition: text-shadow 0.3s ease;
    }

    .glass:hover .star {
      text-shadow: 0 0 8px gold, 0 0 12px orange, 0 0 16px #D2691E;
    }

    .delivery-badge {
      position: absolute;
      top: 10px;
      right: -100%;
      background: rgba(210, 105, 30, 0.85);
      color: white;
      font-weight: bold;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      transition: right 0.4s ease;
      z-index: 10;
      font-size: 0.8rem;
    }

    .glass:hover .delivery-badge {
      right: 10px;
    }

    .filter-section {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-section:hover {
      color: #D2691E;
      font-weight: 600;
    }
  </style>
</head>
<body class="min-h-screen p-6 text-white">

  <div class="container mx-auto">

    <!-- Search Bar -->
    <div class="flex mb-8 glass p-4 rounded-xl">
      <input type="text" id="searchInput" placeholder="Search products..." 
             class="flex-grow p-3 text-white bg-transparent placeholder-white/70 focus:outline-none rounded-lg">
      <button class="gradient-button ml-4" onclick="applyFilters()">Search</button>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">

      <!-- Sidebar Filters -->
      <aside class="lg:w-1/4 w-full glass p-6 space-y-4 sticky top-4 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 text-white">Filters</h2>

        <!-- Category Filter -->
        <div>
          <label class="block mb-2 font-medium">Category</label>
          <select id="categoryFilter" class="w-full p-2 rounded-lg bg-white/20 text-white">
            <option value="">All</option>
          </select>
        </div>

        <!-- Price Range Filter -->
        <div>
          <label class="block mb-2 font-medium">Price Range ($)</label>
          <div class="flex gap-2">
            <input type="number" id="minPrice" placeholder="Min" class="w-1/2 p-2 rounded-lg bg-white/20 text-white">
            <input type="number" id="maxPrice" placeholder="Max" class="w-1/2 p-2 rounded-lg bg-white/20 text-white">
          </div>
        </div>

        <!-- Rating Filter -->
        <div>
          <label class="block mb-2 font-medium">Rating</label>
          <select id="ratingFilter" class="w-full p-2 rounded-lg bg-white/20 text-white">
            <option value="">All</option>
            <option value="5">★★★★★</option>
            <option value="4">★★★★</option>
            <option value="3">★★★</option>
            <option value="2">★★</option>
            <option value="1">★</option>
          </select>
        </div>

        <!-- Delivery removed: not used -->

        <button class="gradient-button w-full mt-4" onclick="applyFilters()">Apply Filters</button>
      </aside>

      <!-- Product Grid -->
      <main class="lg:w-3/4 w-full">
        <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <!-- product cards will be rendered here dynamically -->
        </div>
      </main>
    </div>
  </div>

  <script>
    // Fetch and render products (all approved) or single product when ad_id provided
    function applyFilters() {
      const searchValue = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
      const rating = document.getElementById('ratingFilter').value;

      const products = document.querySelectorAll('#productGrid > .glass');

      products.forEach(product => {
        const name = (product.dataset.name || '').toLowerCase();
        const productCategory = product.dataset.category || '';
        const price = parseFloat(product.dataset.price) || 0;
        const productRating = product.dataset.rating || '';
        const productDelivery = '';

        let show = true;

        if(searchValue && !name.includes(searchValue)) show = false;
        if(category && category !== productCategory) show = false;
        if(price < minPrice || price > maxPrice) show = false;
        if(rating && rating !== productRating) show = false;
        // delivery removed

        product.style.display = show ? 'block' : 'none';
      });
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);

    // Populate categories dynamically from backend to avoid hardcoded mismatches
    async function loadCategories() {
      try {
        const res = await fetch('../backend/get_categories.php');
        if (!res.ok) {
          console.debug('get_categories.php error', res.status, await res.text());
          return;
        }
        const categories = await res.json();
        const sel = document.getElementById('categoryFilter');
        // clear existing non-all options
        Array.from(sel.querySelectorAll('option')).forEach(opt => { if (opt.value !== '') opt.remove(); });
        categories.forEach(cat => {
          const o = document.createElement('option');
          o.value = cat;
          o.textContent = cat;
          sel.appendChild(o);
        });
      } catch (e) {
        console.debug('loadCategories exception', e);
      }
    }

    // call once at startup
    loadCategories();

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    async function fetchProductByAdId(adId) {
      try {
        const res = await fetch(`../backend/get_product.php?ad_id=${encodeURIComponent(adId)}`);
        if (!res.ok) {
          const text = await res.text();
          console.debug('get_product.php error', res.status, text);
          return null;
        }
        const data = await res.json();
        console.debug('get_product.php response', data);
        return data && Object.keys(data).length ? data : null;
      } catch (e) {
        console.debug('get_product.php fetch exception', e);
        return null;
      }
    }

    async function fetchAllProducts() {
      try {
        const res = await fetch(`../backend/get_products.php`);
        if (!res.ok) {
          const text = await res.text();
          console.debug('get_products.php error', res.status, text);
          return [];
        }
        const data = await res.json();
        console.debug('get_products.php response', data);
        return Array.isArray(data) ? data : [];
      } catch (e) {
        console.debug('get_products.php fetch exception', e);
        return [];
      }
    }

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'glass p-5 transition';
      card.dataset.name = product.product_name || '';
      card.dataset.category = product.category || '';
      card.dataset.price = product.price || 0;
      card.dataset.rating = product.rating || 0;

      const imgWrap = document.createElement('div');
      imgWrap.className = 'w-full h-40 mb-4 bg-white/10 rounded-xl flex items-center justify-center text-white/70';
      if (product.image_url) {
        const img = document.createElement('img');
        let src = product.image_url || '';
        if (!/^https?:\/\//i.test(src)) {
          if (src.startsWith('/')) {
            // absolute from webroot - leave as-is
          } else {
            // relative path stored like "uploads/..." -> page is in /pages/ so prefix ../
            src = '../' + src;
          }
        }
        img.src = src;
        img.alt = product.product_name || 'Product Image';
        img.className = 'object-cover w-full h-full rounded-xl';
        imgWrap.innerHTML = '';
        imgWrap.appendChild(img);
      } else {
        imgWrap.textContent = 'Product Image';
      }
      card.appendChild(imgWrap);

      const h3 = document.createElement('h3');
      h3.className = 'text-white font-semibold text-lg mb-1';
      h3.textContent = product.product_name || '';
      card.appendChild(h3);

      const starContainer = document.createElement('div');
      starContainer.className = 'flex items-center mt-2 space-x-1 star-container';
      const rating = parseInt(product.rating) || 0;
      for (let i=1;i<=5;i++){
        const star = document.createElement('span');
        star.className = 'star';
        star.innerHTML = i <= rating ? '★' : '☆';
        starContainer.appendChild(star);
      }
      card.appendChild(starContainer);

      const bottom = document.createElement('div');
      bottom.className = 'flex items-center justify-between mt-3';
      const price = document.createElement('span');
      price.className = 'text-white font-bold text-lg';
      price.textContent = `$${product.price}`;
      const cat = document.createElement('span');
      cat.className = 'px-3 py-1 bg-white/20 rounded-full text-xs text-white/80';
      cat.textContent = product.category || '';
      bottom.appendChild(price);
      bottom.appendChild(cat);
      card.appendChild(bottom);

      const btn = document.createElement('button');
      btn.className = 'gradient-button mt-4 w-full';
      btn.textContent = 'Details';
      // navigate to details page with ad_id when clicked
      btn.addEventListener('click', () => {
        if (product.ad_id) {
          window.location.href = `../pages/5.C4F3_Product_Details_Page.html?ad_id=${encodeURIComponent(product.ad_id)}`;
        }
      });
      card.appendChild(btn);

      return card;
    }

    async function loadProducts() {
      const adId = getQueryParam('ad_id');
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';

      if (adId) {
        const product = await fetchProductByAdId(adId);
        if (product) {
          grid.appendChild(createProductCard(product));
          return;
        }
        // if not found, fallthrough to load all products
      }

      const products = await fetchAllProducts();
      if (!products.length) {
        grid.innerHTML = '<div class="glass p-6">No approved products found.</div>';
        return;
      }

      for (const p of products) {
        grid.appendChild(createProductCard(p));
      }
    }

    // initial load
    loadProducts();
  </script>

</body>
</html>
